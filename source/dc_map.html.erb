<link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.css"/>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.min.js"></script>
<%= javascript_include_tag  "dc" %>

<style type="text/css" media="screen">
html, body {
	height: 100%;
}

section {
	height: 90%;
	display: flex;
	justify-content: center;
}

#filters {
	display: flex;
	justify-content: center;
	align-items: center;
}

@media all and (orientation: landscape) {
	section {
		flex-direction: row;
	}

	#choropleth {
		width: 38.2%;
		height: 100%;
	}

	#filters {
		width: 61.8%;
		height: 100%;
		flex-direction: column;
	}

	#histogram {
		width: 100%;
		height: 61.8%;
	}

	#pie {
		width: 100%;
		height: 38.2%;
	}

}

@media all and (orientation: portrait) {
	section {
		flex-direction: column;
	}

	#choropleth {
		width: 100%;
		height: 61.8%;
	}

	#filters {
		width: 100%;
		height: 38.2%;
		flex-direction: row;
	}

	#histogram {
		width: 61.8%;
		height: 100%;
	}

	#pie {
		width: 38.2%;
		height: 100%;
	}
}

h1 {
	font-size: 1.5rem;
	text-align: center;
	height: 10%;
	margin: 0;
}

h2 {
	font-size: 1rem;
	display: inline;
	margin: 2px;
}

#choropleth path{
	stroke: gray;
	stroke-linejoin: round;
}

#choropleth {
	position: relative;
	padding: 0px;
	margin: 0px;
}

aside > div {
	padding: 0px;
	margin: 0px;	
}

#legend {
    position: absolute;
    top: 3rem;
    left: 1rem;
    height: 40%;
    min-height: 12rem;
}

.list-inline {
	border: 1px solid lightgray;
    padding: 5px;
	height: 100%;
	display: flex;
	flex-direction: column;
	align-items: flex-start;
	align-content: stretch;
}

.list-inline, .list-inline>li {
	list-style: none;
	margin: 0;
}

li.key {
	padding: 0;
	display: block;
	flex-grow: 1;
    border-left-width: 15px;
    border-left-style: solid;
    font-size: .6rem;
    height: 1.6rem;
    padding-left: 5px;
    padding-right: 0px;
    padding-top: .2rem;
}

.clearfix {
	clear: both;
}

</style>

<h1>Reported Rat Sightings in NYC from 2010 to 2014</h1>
<section>
	<div id="choropleth">
		<div id="legend"></div>
		<div>
			<h2>By Zip Code</h2>
			<span class="reset" style="display: none;">Current filter: <span class="filter"></span></span> 
			<a class="reset" href="javascript:choropleth.filterAll();dc.redrawAll();" style="display: none;">reset</a>
		</div>
	</div>
	<aside id="filters">
		<div id="histogram">
			<div>
				<h2>By Month</h2>
				<span class="reset" style="display: none;">Current filter: <span class="filter"></span></span> 
				<a class="reset" href="javascript:histogram.filterAll();dc.redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
		<div id="pie">
			<div>
				<h2>By Borough</h2>
				<span class="reset" style="display: none;">Current filter: <span class="filter"></span></span> 
				<a class="reset" href="javascript:pie.filterAll();dc.redrawAll();" style="display: none;">reset</a>
			</div>
		</div>
	</aside>
</section>

<script>

	var margin = {top: 10, left: 10, bottom: 10, right: 10};

	var mapWidth = parseInt(d3.select('#choropleth').style('width'))
	  , mapWidth = mapWidth - margin.left - margin.right
	  , mapHeight = parseInt(d3.select('#choropleth').style('height'))
	  , mapHeight = mapHeight - margin.top - margin.bottom;

	var histWidth = parseInt(d3.select('#histogram').style('width'))
	  , histWidth = histWidth - margin.left - margin.right
	  , histHeight = parseInt(d3.select('#histogram').style('height'))
	  , histHeight = histHeight - margin.top - margin.bottom;

	var pieWidth = parseInt(d3.select('#pie').style('width'))
	  , pieWidth = pieWidth - margin.left - margin.right
	  , pieHeight = parseInt(d3.select('#pie').style('height'))
	  , pieHeight = pieHeight - margin.top - margin.bottom;

	var parseDate = d3.time.format("%m/%d/%Y %I:%M:%S %p").parse;
	var formatDate = d3.time.format("%m/%y");
	var formatCount = d3.format(",.0f");


	// Thanks to http://colorbrewer2.org/
	var colorScale = d3.scale.quantize().range(['rgb(255,255,229)','rgb(247,252,185)','rgb(217,240,163)','rgb(173,221,142)','rgb(120,198,121)','rgb(65,171,93)','rgb(35,132,67)','rgb(0,104,55)','rgb(0,69,41)']);

	// Figure out scale and translate for geo projection
	// Thanks to http://stackoverflow.com/questions/14492284/center-a-map-in-d3-given-a-geojson-object
	// Create a unit projection.
	var projection = d3.geo.albers()
	    .scale(1)
	    .translate([0, 0]);

	// Create a path generator.
	var path = d3.geo.path()
	    .projection(projection);

	var choropleth = dc.geoChoroplethChart("#choropleth");
	var histogram = dc.barChart("#histogram");
	var pie = dc.pieChart("#pie");


	d3.csv("data/Rat_Sightings.csv", function(error, rawData) {

		rawData.forEach(function(d) {
			d.created_date = parseDate(d["Created Date"]);
			d.month = d3.time.month(d.created_date);
		});

		var data = crossfilter(rawData);
		var all = data.groupAll();

		var zipCodes = data.dimension(function(d) {
			return d["Incident Zip"];
		});
		var zipCodeCounts = zipCodes.group();

		var time = data.dimension(function(d) {
		    return d.month;
		});
		var timeCounts = time.group().reduceCount();

		var borough = data.dimension(function(d) {
			return d["Borough"];
		});
		var boroughCounts = borough.group().reduceCount();

		var timeScale = d3.time.scale().domain([(new Date(2010,12,31)), (new Date(2014,10,01))]);

		d3.json("data/nyc-zip-code.json", function(nycZipJson) {

			// Compute the bounds of a feature of interest, then derive scale & translate.
			var b = path.bounds(nycZipJson),
			    s = .95 / Math.max((b[1][0] - b[0][0]) / mapWidth, (b[1][1] - b[0][1]) / mapHeight),
			    t = [(mapWidth - s * (b[1][0] + b[0][0])) / 2, (mapHeight - s * (b[1][1] + b[0][1])) / 2];

			// Update the projection to use computed scale & translate.
			projection
			    .scale(s)
			    .translate(t);

			choropleth.width(mapWidth)
				.height(mapHeight)
				.dimension(zipCodes)
				.group(zipCodeCounts, "Rat Sightings by Zip Code")
				.colors(colorScale)
				.colorAccessor(function(d) {
					return d.value;
				})
				.colorCalculator(function(d) {
					return d ? choropleth.colors()(d) : 'gray';
				})
				.overlayGeoJson(nycZipJson.features, "zip_code", function(d) {
					return d.properties.ZIP;
				})
				.projection(projection)
				.title(function(d) {
					return "Zip Code: " + d.key + "\nNumber of Sightings: " + d.value;
				});

			choropleth.calculateColorDomain();

			// Create a legend for the choropleth
			// Thanks to http://eyeseast.github.io/visible-data/2013/08/27/responsive-legends-with-d3/
			var legend = d3.select('#legend')
				.append('ul')
			    .attr('class', 'list-inline');

			var keys = legend.selectAll('li.key')
			    .data(colorScale.range());

			keys.enter().append('li')
			    .attr('class', 'key')
			    .style('border-left-color', String)
			    .text(function(d) {
			        var r = colorScale.invertExtent(d);
			        return formatCount(r[0]);
			    });

			histogram.width(histWidth)
				.height(histHeight)
				.margins({top: 10, right: 10, bottom: 20, left: 40})
				.dimension(time)
				.group(timeCounts)
				.x(timeScale)
				.round(d3.time.month.round)
				.xUnits(d3.time.months)
				.elasticY(true)
				.renderHorizontalGridLines(true);


			pie.width(pieWidth)
				.height(pieHeight)
				.dimension(borough)
				.group(boroughCounts)
				.colors(d3.scale.category10())
				.label(function (d) {
		            if (pie.hasFilter() && !pie.hasFilter(d.key))
		                return d.key + " (0%)";
		            var label = d.key;
		            if(all.value())
		                label += " (" + Math.floor(d.value / all.value() * 100) + "%)";
		            return label;
		        });

			var updateChloroplethScale = function(chart, filter) {
				var domain = [d3.min(choropleth.group().all(), choropleth.colorAccessor()),
							  d3.max(choropleth.group().all(), choropleth.colorAccessor())];
				choropleth.colorDomain(domain);
			}
			pie.on('filtered', updateChloroplethScale);
			histogram.on('filtered', updateChloroplethScale);

			choropleth.renderlet(function(chart) {
				d3.select('#legend').selectAll('li.key')
				    .data(chart.colors().range())
				    .text(function(d) {
				        var r = chart.colors().invertExtent(d);
				        return formatCount(r[0]);
				    });

			});

			dc.renderAll();
		});

	});


</script>